name: Sync Macros to Satellite Repos

on:
  push:
    branches:
      - main
    paths:
      - 'Macros/**'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        macro:
          - name: CoplanarSketch
            path: Macros/CoplanarSketch
            repo: CoplanarSketch
          - name: VarSet-Update
            path: Macros/VarSet-Update
            repo: VarSet-Update
          - name: TopoMatchSelector
            path: Macros/TopoMatchSelector
            repo: TopoMatchSelector
          - name: EdgeLoopSelector
            path: Macros/EdgeLoopSelector
            repo: EdgeLoopSelector
          - name: SketchReProfile
            path: Macros/SketchReProfile
            repo: SketchReProfile
          - name: MeshPlacement
            path: Macros/MeshPlacement
            repo: MeshPlacement
          - name: MeshToBody
            path: Macros/MeshToBody
            repo: MeshToBody
          - name: SketcherWireDoctor
            path: Macros/SketcherWireDoctor
            repo: SketcherWireDoctor

    steps:
      - name: Checkout Detessellate
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Default GITHUB_TOKEN is fine for reading this repo

      - name: Check if macro changed
        id: changed
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${{ matrix.macro.path }}/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout satellite repo
        if: steps.changed.outputs.changed == 'true'
        uses: actions/checkout@v4
        with:
          repository: DesignWeaver3D/${{ matrix.macro.repo }}
          token: ${{ secrets.PAT_TOKEN }}
          path: satellite-repo

      - name: Sync ${{ matrix.macro.name }}
        if: steps.changed.outputs.changed == 'true'
        run: |
          echo "================================================"
          echo "Syncing: ${{ matrix.macro.name }}"
          echo "Source path: ${{ matrix.macro.path }}"
          echo "Target repo: DesignWeaver3D/${{ matrix.macro.repo }}"
          echo "================================================"

          cd satellite-repo

          # Remove old content (except .git)
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # Copy new content from macro folder (robust against empty dirs)
          rsync -av --delete ../${{ matrix.macro.path }}/ .

          # Configure git
          git config user.name "Detessellate Sync Bot"
          git config user.email "actions@github.com"

          # Commit and push changes
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync from Detessellate @ ${{ github.sha }}"
            git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/DesignWeaver3D/${{ matrix.macro.repo }}.git
            git push origin main --force
            git push origin main --force || (sleep 10 && git push origin main --force)
            echo "âœ“ Sync complete for ${{ matrix.macro.name }}"
          fi
